/*
 * GNU AGPL-3.0 License
 *
 * Copyright (c) 2021 - present core.ai . All rights reserved.
 *
 * This program is free software: you can redistribute it and/or modify it
 * under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License
 * for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.
 *
 */

/* AI Chat Panel — sidebar chat UI for Claude Code integration */

.ai-chat-panel {
    display: flex;
    flex-direction: column;
    -webkit-box-flex: 1;
    min-height: 0;
    overflow: hidden;
    background-color: @bc-sidebar-bg;
    color: @project-panel-text-1;
    font-size: 13px;
}

/* ── Header ─────────────────────────────────────────────────────────── */
.ai-chat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 10px 9px 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    flex-shrink: 0;

    .ai-chat-title {
        font-weight: 400;
        font-size: @label-font-size;
        color: @project-panel-text-2;
        line-height: 19px;
    }

    .ai-new-session-btn {
        display: flex;
        align-items: center;
        gap: 4px;
        background: none;
        border: none;
        color: @project-panel-text-2;
        font-size: @menu-item-font-size;
        padding: 0 8px;
        border-radius: 3px;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.15s ease, background-color 0.15s ease;

        &:hover {
            opacity: 1;
            background-color: rgba(255, 255, 255, 0.06);
        }
    }
}

/* ── Message list ───────────────────────────────────────────────────── */
.ai-chat-messages {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 8px 10px;
    min-height: 0;
    min-width: 0;
}

/* ── Individual messages ────────────────────────────────────────────── */
.ai-msg {
    margin-bottom: 12px;
    max-width: 100%;

    .ai-msg-label {
        font-size: 11px;
        color: @project-panel-text-2;
        margin-bottom: 3px;
        font-weight: 600;
        opacity: 0.6;
    }

    .ai-msg-content {
        font-size: 13px;
        line-height: 1.55;
        white-space: normal;
        word-wrap: break-word;
        overflow-wrap: anywhere;
        min-width: 0;
        user-select: text;
        cursor: text;
    }
}

/* ── User message ───────────────────────────────────────────────────── */
.ai-msg-user {
    display: flex;
    flex-direction: column;
    align-items: flex-end;

    .ai-msg-label {
        margin-right: 2px;
    }

    .ai-msg-content {
        background-color: rgba(255, 255, 255, 0.07);
        padding: 6px 10px;
        border-radius: 10px 10px 2px 10px;
        max-width: 88%;
        text-align: left;
    }
}

/* ── Assistant message — markdown content ───────────────────────────── */
.ai-msg-assistant {
    .ai-msg-content {
        padding: 2px 0;

        > *:first-child {
            margin-top: 0;
        }

        > *:last-child {
            margin-bottom: 0;
        }

        p {
            margin: 0 0 8px 0;

            &:last-child {
                margin-bottom: 0;
            }
        }

        strong {
            color: @project-panel-text-1;
            font-weight: 600;
        }

        code {
            background-color: rgba(255, 255, 255, 0.08);
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 12px;
            font-family: 'SourceCodePro-Medium', 'SourceCodePro', monospace;
        }

        pre {
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.06);
            padding: 8px 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 6px 0;

            code {
                background: none;
                padding: 0;
                border-radius: 0;
                font-size: 12px;
                line-height: 1.5;
                color: @project-panel-text-1;
            }
        }

        ul, ol {
            margin: 4px 0 8px 0;
            padding-left: 18px;
        }

        li {
            margin-bottom: 2px;
        }

        blockquote {
            border-left: 2px solid rgba(255, 255, 255, 0.12);
            margin: 6px 0;
            padding: 2px 10px;
            color: @project-panel-text-2;
        }

        h1, h2, h3, h4 {
            font-weight: 600;
            color: @project-panel-text-1;
        }

        h1 { font-size: @label-font-size; margin: 12px 0 4px 0; }
        h2 { font-size: @menu-item-font-size; margin: 10px 0 4px 0; }
        h3 { font-size: 13px; margin: 8px 0 3px 0; }
        h4 { font-size: 13px; margin: 6px 0 2px 0; opacity: 0.85; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 6px 0;
            font-size: 12px;
        }

        th, td {
            padding: 4px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        th {
            font-weight: 600;
            color: @project-panel-text-2;
            border-bottom-color: rgba(255, 255, 255, 0.1);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        hr {
            border: none;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            margin: 8px 0;
        }
    }
}

/* ── Tool use indicator ─────────────────────────────────────────────── */
.ai-msg-tool {
    margin-bottom: 3px;
    border-radius: 4px;
    background-color: rgba(255, 255, 255, 0.025);
    border-left: 2px solid var(--tool-color, @project-panel-text-2);

    .ai-tool-header {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        white-space: normal;
    }

    .ai-tool-icon {
        font-size: 11px;
        width: 14px;
        text-align: center;
        flex-shrink: 0;
    }

    .ai-tool-spinner {
        display: inline-block;
        width: 10px;
        height: 10px;
        border: 1.5px solid rgba(255, 255, 255, 0.1);
        border-top-color: var(--tool-color, @project-panel-text-2);
        border-radius: 50%;
        animation: ai-spin 0.7s linear infinite;
        flex-shrink: 0;
    }

    .ai-tool-label {
        font-size: 12px;
        color: @project-panel-text-2;
        line-height: 1.3;

        &.ai-tool-label-clickable:hover {
            color: @project-panel-text-1;
            text-decoration: underline;
        }
    }

    .ai-tool-detail {
        display: none;
        padding: 0 8px 4px 28px;
    }

    .ai-tool-screenshot {
        max-width: 100%;
        border-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-top: 4px;
        max-height: 120px;
        object-fit: cover;
        object-position: top left;
        cursor: pointer;
        transition: max-height 0.2s ease;
    }

    &.ai-tool-expanded .ai-tool-screenshot.expanded {
        max-height: none;
    }

    .ai-tool-detail-line {
        font-size: 11px;
        font-family: 'SourceCodePro-Medium', 'SourceCodePro', monospace;
        color: @project-panel-text-2;
        opacity: 0.7;
        line-height: 1.5;
        white-space: normal;
        word-break: break-all;
    }

    .ai-tool-preview {
        font-size: 11px;
        font-family: 'SourceCodePro-Medium', 'SourceCodePro', monospace;
        color: @project-panel-text-2;
        opacity: 0.5;
        padding: 0 8px 4px 28px;
        line-height: 1.4;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;

        &:empty {
            display: none;
        }
    }

    &.ai-tool-done {
        .ai-tool-preview {
            display: none;
        }

        .ai-tool-label {
            opacity: 0.75;
        }
    }

    &.ai-tool-expanded .ai-tool-detail {
        display: block;
    }

    // Expand chevron hint
    &.ai-tool-done .ai-tool-header:hover .ai-tool-label {
        opacity: 1;
    }

    // Inline edit actions (diff toggle)
    .ai-tool-edit-actions {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 2px 8px 4px 28px;
    }

    .ai-tool-diff-toggle {
        background: none;
        border: none;
        font-size: 11px;
        color: @project-panel-text-2;
        padding: 1px 4px;
        cursor: pointer;
        opacity: 0.6;
        transition: opacity 0.15s ease;

        &:hover {
            opacity: 1;
        }
    }

    .ai-tool-diff {
        display: none;
        padding: 4px 8px 4px 28px;
        font-size: 12px;
        font-family: 'SourceCodePro-Medium', 'SourceCodePro', monospace;
        line-height: 1.5;
        overflow-x: auto;
        background-color: rgba(0, 0, 0, 0.15);

        &.expanded {
            display: block;
        }

        .ai-diff-old {
            color: #e88;
            background-color: rgba(255, 80, 80, 0.06);
        }

        .ai-diff-new {
            color: #8c8;
            background-color: rgba(80, 200, 80, 0.06);
        }
    }

    .ai-tool-edit-error {
        font-size: 12px;
        color: #e88;
        padding: 3px 8px 3px 28px;
    }

    .ai-tool-elapsed {
        font-size: 11px;
        color: @project-panel-text-2;
        opacity: 0.5;
        margin-left: auto;
    }
}

/* ── TodoWrite task list widget ────────────────────────────────────── */
.ai-todo-list {
    padding: 2px 8px 4px 28px;
}

.ai-todo-item {
    display: flex;
    align-items: flex-start;
    gap: 6px;
    padding: 2px 0;
    font-size: 12px;
}

.ai-todo-icon {
    width: 14px;
    text-align: center;
    flex-shrink: 0;
    font-size: 11px;

    &.completed { color: #66bb6a; }
    &.in_progress { color: #e8a838; }
    &.pending { color: @project-panel-text-2; opacity: 0.4; }
}

.ai-todo-content {
    color: @project-panel-text-2;
    line-height: 1.4;

    &.completed {
        text-decoration: line-through;
        opacity: 0.6;
    }
}

@keyframes ai-spin {
    to { transform: rotate(360deg); }
}

/* ── Thinking indicator ─────────────────────────────────────────────── */
.ai-thinking-dots {
    display: inline-flex;
    gap: 3px;
    padding: 4px 0;

    span {
        display: inline-block;
        width: 5px;
        height: 5px;
        border-radius: 50%;
        background-color: @project-panel-text-2;
        opacity: 0.3;
        animation: ai-dot-pulse 1.2s ease-in-out infinite;

        &:nth-child(2) { animation-delay: 0.2s; }
        &:nth-child(3) { animation-delay: 0.4s; }
    }
}

@keyframes ai-dot-pulse {
    0%, 60%, 100% { opacity: 0.2; transform: scale(0.8); }
    30% { opacity: 0.8; transform: scale(1); }
}

/* ── Edit summary card ──────────────────────────────────────────────── */
.ai-msg-edit-summary {
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 4px;
    margin-bottom: 6px;
    padding: 6px 10px;
    background-color: rgba(255, 255, 255, 0.025);

    .ai-edit-summary-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 12px;
        font-weight: 600;
        color: @project-panel-text-2;
        margin-bottom: 4px;
    }

    .ai-edit-restore-btn {
        background: none;
        border: 1px solid rgba(200, 160, 80, 0.3);
        color: rgba(220, 180, 100, 0.9);
        font-size: 11px;
        padding: 1px 8px;
        border-radius: 3px;
        cursor: pointer;
        flex-shrink: 0;
        transition: background-color 0.15s ease, color 0.15s ease, border-color 0.15s ease;

        &:hover {
            background-color: rgba(200, 160, 80, 0.08);
        }

        &:disabled {
            opacity: 0.5;
            cursor: default;
        }
    }

    .ai-edit-summary-file {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 2px 0;
        cursor: pointer;
        transition: background-color 0.15s ease;

        &:hover {
            background-color: rgba(255, 255, 255, 0.04);
        }

        .ai-edit-summary-name {
            font-size: 12px;
            font-family: 'SourceCodePro-Medium', 'SourceCodePro', monospace;
            color: @project-panel-text-2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            margin-right: 8px;

            &:hover {
                color: @project-panel-text-1;
                text-decoration: underline;
            }
        }

        .ai-edit-summary-stats {
            display: flex;
            gap: 6px;
            font-size: 11px;
            font-family: 'SourceCodePro-Medium', 'SourceCodePro', monospace;
            flex-shrink: 0;
        }

        .ai-edit-summary-add {
            color: #8c8;
        }

        .ai-edit-summary-del {
            color: #e88;
        }
    }
}

/* ── Initial restore point (PUC) ────────────────────────────────────── */
.ai-msg-restore-point {
    display: flex;
    justify-content: center;
    margin-bottom: 6px;
    padding: 2px 0;

    .ai-restore-point-btn {
        background: none;
        border: 1px dashed rgba(200, 160, 80, 0.3);
        color: rgba(220, 180, 100, 0.7);
        font-size: 11px;
        padding: 2px 14px;
        border-radius: 3px;
        cursor: pointer;
        transition: background-color 0.15s ease, color 0.15s ease, border-color 0.15s ease;

        &:hover:not(:disabled) {
            background-color: rgba(200, 160, 80, 0.08);
            border-color: rgba(200, 160, 80, 0.5);
            color: rgba(220, 180, 100, 0.9);
        }

        &:disabled {
            opacity: 0.35;
            cursor: default;
        }
    }

    &.ai-restore-highlighted {
        .ai-restore-point-btn {
            border-color: rgba(100, 200, 100, 0.5);
            border-style: solid;
            color: rgba(140, 200, 140, 0.9);
            background-color: rgba(100, 200, 100, 0.06);
        }
    }
}

/* ── Restore highlight on summary cards ────────────────────────────── */
.ai-msg-edit-summary.ai-restore-highlighted {
    border-color: rgba(100, 200, 100, 0.3);
    background-color: rgba(100, 200, 100, 0.04);

    .ai-edit-restore-btn {
        border-color: rgba(100, 200, 100, 0.4);
        color: rgba(140, 200, 140, 0.9);
        cursor: default;

        &:hover {
            background-color: rgba(100, 200, 100, 0.06);
        }
    }
}

/* ── Error message ──────────────────────────────────────────────────── */
.ai-msg-error {
    .ai-msg-content {
        color: #e88;
        border-left: 2px solid rgba(255, 80, 80, 0.4);
        padding: 4px 8px;
        font-size: 12px;
        background-color: rgba(255, 80, 80, 0.04);
        border-radius: 0 3px 3px 0;
    }
}

/* ── Status bar ─────────────────────────────────────────────────────── */
.ai-chat-status {
    display: none;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    font-size: 12px;
    color: @project-panel-text-2;
    flex-shrink: 0;
    opacity: 0.6;

    &.active {
        display: flex;
    }

    .ai-status-spinner {
        display: inline-block;
        width: 9px;
        height: 9px;
        border: 1.5px solid rgba(255, 255, 255, 0.1);
        border-top-color: @project-panel-text-2;
        border-radius: 50%;
        animation: ai-spin 0.7s linear infinite;
    }
}

/* ── Input area ─────────────────────────────────────────────────────── */
.ai-chat-input-area {
    flex-shrink: 0;
    padding: 6px 8px 8px 8px;

    .ai-chat-input-wrap {
        display: flex;
        align-items: flex-end;
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        transition: border-color 0.15s ease;
        overflow: hidden;

        &:focus-within {
            border-color: @bc-btn-border-focused;
        }

        &.disabled {
            opacity: 0.5;
        }
    }

    .ai-chat-context-bar {
        display: none;
        flex-wrap: wrap;
        gap: 4px;
        padding: 0 4px 4px 4px;

        &.has-chips {
            display: flex;
        }
    }

    .ai-context-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
        line-height: 1;
        padding: 3px 6px;
        border-radius: 3px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: @project-panel-text-2;
        background: rgba(255, 255, 255, 0.04);
        max-width: 100%;
        overflow: hidden;

        .ai-context-chip-icon {
            flex-shrink: 0;
            font-size: 10px;
            opacity: 0.7;
        }

        .ai-context-chip-label {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ai-context-chip-close {
            flex-shrink: 0;
            background: none;
            border: none;
            color: @project-panel-text-2;
            font-size: 12px;
            line-height: 1;
            padding: 0 0 0 2px;
            cursor: pointer;
            opacity: 0.5;

            &:hover {
                opacity: 1;
            }
        }
    }

    .ai-context-chip-livepreview {
        border-color: rgba(76, 175, 80, 0.3);
        .ai-context-chip-icon { color: #66bb6a; }
    }

    .ai-context-chip-selection {
        border-color: rgba(107, 158, 255, 0.3);
        .ai-context-chip-icon { color: #6b9eff; }
    }

    .ai-chat-textarea {
        flex: 1;
        min-width: 0;
        background: none;
        border: none !important;
        color: @project-panel-text-1;
        font-size: 13px;
        font-family: inherit;
        padding: 7px 0 7px 10px;
        margin: 0;
        resize: none;
        min-height: 20px;
        max-height: 96px;
        line-height: 1.4;
        outline: none !important;
        box-shadow: none !important;

        &:disabled {
            cursor: not-allowed;
        }
    }

    .ai-send-btn {
        background: none;
        border: none;
        color: @project-panel-text-2;
        width: 30px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        align-self: stretch;
        border-radius: 0 7px 7px 0;
        opacity: 0.5;
        transition: opacity 0.15s ease, color 0.15s ease;

        &:hover {
            opacity: 1;
            color: @project-panel-text-1;
        }

        &:disabled {
            opacity: 0.2;
            cursor: not-allowed;
        }

        i {
            font-size: 13px;
        }
    }

    .ai-stop-btn {
        background: none;
        border: none;
        color: #e06c75;
        width: 30px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        align-self: stretch;
        border-radius: 0 7px 7px 0;
        opacity: 0.7;
        transition: opacity 0.15s ease;

        &:hover {
            opacity: 1;
        }

        i {
            font-size: 13px;
        }
    }
}

/* ── Unavailable / placeholder state ────────────────────────────────── */
.ai-unavailable {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    padding: 2rem;
    text-align: center;
    color: @project-panel-text-2;

    .ai-unavailable-icon {
        font-size: 2rem;
        margin-bottom: 1rem;
        opacity: 0.4;
    }

    .ai-unavailable-title {
        font-size: @menu-item-font-size;
        font-weight: 600;
        color: @project-panel-text-1;
        margin-bottom: 6px;
    }

    .ai-unavailable-message {
        font-size: 12px;
        line-height: 1.5;
        margin-bottom: 12px;
        opacity: 0.6;
    }

    .ai-retry-btn {
        background: none;
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: @project-panel-text-2;
        font-size: 12px;
        padding: 3px 12px;
        border-radius: 3px;
        cursor: pointer;
        transition: background-color 0.15s ease, color 0.15s ease;

        &:hover {
            background-color: rgba(255, 255, 255, 0.06);
            color: @project-panel-text-1;
        }
    }
}
